<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025-2026 기업 비용 지출 분석 (즉시보기)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800" ondragover="event.preventDefault()" ondrop="handleDrop(event)">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-5 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="pie-chart"></i> 시대에듀 법인카드 지출 분석
                </h1>
                <p class="text-slate-400 text-xs mt-1">2025.01.19 ~ 2026.01.19 | 우리체크카드 (2771)</p>
            </div>
            <div>
                <button onclick="document.getElementById('csvInput').click()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-bold transition flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> 전체 데이터 반영하기
                </button>
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto p-6 space-y-6">
        
        <!-- Summary Cards (Pre-filled with parsed metadata) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Total Spend -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">총 이용금액</h3>
                    <div class="p-1.5 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="totalAmount">68,896,874원</p>
                <p class="text-xs text-slate-400 mt-1">이용기간 전체 합계</p>
            </div>

            <!-- Count -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">총 승인건수</h3>
                    <div class="p-1.5 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="totalCount">1,062건</p>
                <p class="text-xs text-slate-400 mt-1">취소 건 포함</p>
            </div>

             <!-- Avg Spend -->
             <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">건당 평균</h3>
                    <div class="p-1.5 bg-green-50 rounded-lg text-green-600"><i data-lucide="calculator" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="avgSpend">64,874원</p>
                <p class="text-xs text-slate-400 mt-1">단순 평균 (총액/건수)</p>
            </div>

            <!-- Top Category (Preview) -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">주요 지출처</h3>
                    <div class="p-1.5 bg-orange-50 rounded-lg text-orange-600"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                </div>
                <p class="text-xl font-bold text-slate-900 truncate" id="topStore">SK에너지 외</p>
                <p class="text-xs text-slate-400 mt-1">상세 분석 필요</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Pie Chart -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm lg:col-span-1">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                    <i data-lucide="pie-chart" class="w-4 h-4 text-slate-400"></i> 카테고리별 비중
                </h3>
                <div class="h-64 relative">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Monthly Bar Chart -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm lg:col-span-2">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 text-slate-400"></i> 월별 지출 추이
                </h3>
                <div class="h-64 relative">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4 text-slate-400"></i> 상세 지출 내역
                </h3>
                <span class="text-xs text-slate-500 bg-white px-2 py-1 rounded border">최근 내역 우선</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-100/50">
                        <tr>
                            <th class="px-6 py-3 w-32">날짜</th>
                            <th class="px-6 py-3">가맹점명</th>
                            <th class="px-6 py-3 w-32">카테고리</th>
                            <th class="px-6 py-3 w-40 text-right">금액</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-20 transition-all duration-300 opacity-0 flex items-center gap-3">
        <i data-lucide="info" class="text-blue-400"></i>
        <div>
            <p class="font-bold text-sm">미리보기 데이터 로드됨</p>
            <p class="text-xs text-slate-300">전체 1,062건을 보려면 CSV 파일을 화면에 드래그하세요.</p>
        </div>
    </div>

    <script>
        // --- 1. 사전 분석 데이터 (User File Snippets) ---
        // 파일의 앞/뒤에서 추출한 실제 데이터입니다.
        const PREVIEW_DATA = [
            // From End of File (Recent)
            { date: "2026-01-29", store: "메리엔다", amount: 40800, rawDate: "01.29" },
            { date: "2026-01-28", store: "주식회사 카카오", amount: 13500, rawDate: "01.28" },
            { date: "2026-01-28", store: "파파야리프 코엑", amount: 87500, rawDate: "01.28" },
            { date: "2026-01-27", store: "SK에너지(주)", amount: 142000, rawDate: "01.27" },
            { date: "2026-01-27", store: "(주)신세계 하", amount: 15500, rawDate: "01.27" },
            { date: "2026-01-27", store: "주식회사 스타필", amount: 38000, rawDate: "01.27" },
            { date: "2026-01-26", store: "주식회사 빅바이", amount: 34100, rawDate: "01.26" },
            // From Start of File (Older - Late 2025)
            { date: "2025-12-31", store: "쿠팡", amount: 42600, rawDate: "12.31" },
            { date: "2025-12-31", store: "라체나", amount: 108200, rawDate: "12.31" },
            { date: "2025-12-30", store: "육감만족", amount: 56000, rawDate: "12.30" },
            { date: "2025-12-29", store: "롯데리아 광주퇴", amount: 32700, rawDate: "12.29" },
            { date: "2025-12-29", store: "지호한방삼계탕", amount: 43000, rawDate: "12.29" },
        ];

        // --- 2. 카테고리 분류 로직 ---
        const categories = {
            '식비/카페': ['식당', '요리', '키친', '카페', '커피', '푸드', '국밥', '면', '버거', '피자', '갈비', '육감만족', '라체나', '메리엔다', '파파야리프', '스타벅스', '투썸', '맥도날드', '롯데리아', '삼계탕'],
            '쇼핑/마트': ['쿠팡', '이마트', '신세계', '스타필드', '다이소', '편의점', '마트', '빅바이', '올리브영', '컬리'],
            '교통/차량': ['주유', 'SK', 'GS칼텍스', '오일', '택시', '카카오', '주차', '하이패스', 'S-OIL'],
            '비즈니스': ['주식회사', '코엑', '시대에듀', '우체국', '세무', '법무'],
            '문화/여가': ['CGV', '롯데시네마', '골프', '서점', '문고'],
        };

        function detectCategory(storeName) {
            if (!storeName) return '기타';
            for (const [cat, keywords] of Object.entries(categories)) {
                if (keywords.some(k => storeName.includes(k))) return cat;
            }
            return '기타';
        }

        // --- 3. 차트 및 렌더링 ---
        let categoryChart, monthlyChart;

        function initDashboard(data, isFullData = false) {
            // Process Data for Charts
            const catSum = {};
            const monthSum = {};
            
            // Enrich Data
            const enrichedData = data.map(d => {
                const cat = d.category || detectCategory(d.store);
                const dateObj = new Date(d.date);
                const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
                
                catSum[cat] = (catSum[cat] || 0) + d.amount;
                monthSum[monthKey] = (monthSum[monthKey] || 0) + d.amount;
                
                return { ...d, category: cat, month: monthKey };
            });

            // Update Summary (Only if full data, otherwise keep the parsed metadata from header)
            if (isFullData) {
                const total = enrichedData.reduce((acc, cur) => acc + cur.amount, 0);
                document.getElementById('totalAmount').innerText = total.toLocaleString() + '원';
                document.getElementById('totalCount').innerText = enrichedData.length.toLocaleString() + '건';
                document.getElementById('avgSpend').innerText = Math.round(total / enrichedData.length).toLocaleString() + '원';
                
                // Find Top Store
                const storeSum = {};
                enrichedData.forEach(d => storeSum[d.store] = (storeSum[d.store] || 0) + d.amount);
                const top = Object.keys(storeSum).reduce((a, b) => storeSum[a] > storeSum[b] ? a : b);
                document.getElementById('topStore').innerText = top;
            }

            renderCharts(catSum, monthSum);
            renderTable(enrichedData);

            if (!isFullData) showToast();
        }

        function renderCharts(catSum, monthSum) {
            if (categoryChart) categoryChart.destroy();
            if (monthlyChart) monthlyChart.destroy();

            // Pie Chart
            const sortedCats = Object.entries(catSum).sort((a,b) => b[1] - a[1]);
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedCats.map(x => x[0]),
                    datasets: [{
                        data: sortedCats.map(x => x[1]),
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });

            // Bar Chart
            const sortedMonths = Object.keys(monthSum).sort();
            monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '지출액',
                        data: sortedMonths.map(m => monthSum[m]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2,4] } }, x: { grid: { display: false } } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = data.map(d => `
                <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
                    <td class="px-6 py-3 font-medium text-slate-500">${d.date}</td>
                    <td class="px-6 py-3 font-bold text-slate-800">${d.store}</td>
                    <td class="px-6 py-3"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">${d.category}</span></td>
                    <td class="px-6 py-3 text-right font-bold text-blue-600">${d.amount.toLocaleString()}원</td>
                </tr>
            `).join('');
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 5000);
        }

        // --- 4. 드래그 앤 드롭 & 파일 처리 ---
        function handleDrop(e) {
            e.preventDefault();
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        }

        function handleFile(file) {
            if (!file) return;
            Papa.parse(file, {
                header: false,
                complete: function(results) {
                    processFullData(results.data);
                }
            });
        }

        function processFullData(rows) {
            // Find Header
            let headerIdx = -1;
            for(let i=0; i<30; i++) {
                if(rows[i] && rows[i].some(c => c && c.includes('이용일자'))) {
                    headerIdx = i; break;
                }
            }
            if(headerIdx === -1) { alert("형식을 인식할 수 없습니다."); return; }

            const h = rows[headerIdx];
            const iDate = h.findIndex(c => c.includes('이용일자'));
            const iStore = h.findIndex(c => c.includes('이용가맹점'));
            const iAmt = h.findIndex(c => c.includes('승인금액'));

            const newData = [];
            for(let i=headerIdx+1; i<rows.length; i++) {
                const r = rows[i];
                if(!r[iDate] || !r[iAmt]) continue;
                
                // Parse Amount
                const amtStr = r[iAmt].toString().replace(/,/g,'').replace(/"/g,'').trim();
                const amt = parseFloat(amtStr) || 0;
                
                // Parse Date (Heuristic 2025/2026)
                let [dPart] = r[iDate].split(' ');
                let [m, d] = dPart.split('.').map(Number);
                let y = (m === 1) ? 2026 : 2025;
                let fullDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                newData.push({
                    date: fullDate,
                    store: r[iStore],
                    amount: amt,
                    category: detectCategory(r[iStore])
                });
            }

            initDashboard(newData, true);
        }

        // --- Init ---
        lucide.createIcons();
        window.onload = () => initDashboard(PREVIEW_DATA, false);

    </script>
</body>
</html>
