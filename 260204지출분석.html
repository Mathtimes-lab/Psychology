<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025년 기업 비용 지출 분석 (유사 가맹점 통합)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800" ondragover="event.preventDefault()" ondrop="handleDrop(event)">

    <!-- Header -->
    <header class="bg-slate-900 text-white p-5 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="pie-chart"></i> 시대에듀 법인카드 지출 분석
                </h1>
                <p class="text-slate-400 text-xs mt-1">우리체크카드 (2771) | 유사 가맹점 자동 통합 (주식회사, 공백 제거)</p>
            </div>
            <div>
                <button onclick="document.getElementById('csvInput').click()" class="bg-blue-600 hover:bg-blue-500 text-white text-sm px-4 py-2 rounded-lg font-bold transition flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> CSV 파일 업로드
                </button>
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFile(this.files[0])">
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto p-6 space-y-6">
        
        <!-- Status Message Area -->
        <div id="statusArea" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i data-lucide="alert-circle" class="h-5 w-5 text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700" id="statusMsg"></p>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Total Spend -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">총 이용금액</h3>
                    <div class="p-1.5 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="wallet" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="totalAmount">68,896,874원</p>
                <p class="text-xs text-slate-400 mt-1">2025년 전체 합계</p>
            </div>

            <!-- Count -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">총 승인건수</h3>
                    <div class="p-1.5 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="receipt" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="totalCount">1,062건</p>
                <p class="text-xs text-slate-400 mt-1">취소 건 포함</p>
            </div>

             <!-- Avg Spend -->
             <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">건당 평균</h3>
                    <div class="p-1.5 bg-green-50 rounded-lg text-green-600"><i data-lucide="calculator" class="w-4 h-4"></i></div>
                </div>
                <p class="text-2xl font-bold text-slate-900" id="avgSpend">64,874원</p>
                <p class="text-xs text-slate-400 mt-1">단순 평균</p>
            </div>

            <!-- Top Category -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xs font-bold text-slate-500 uppercase">주요 지출처</h3>
                    <div class="p-1.5 bg-orange-50 rounded-lg text-orange-600"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                </div>
                <p class="text-xl font-bold text-slate-900 truncate" id="topStore">SK에너지 외</p>
                <p class="text-xs text-slate-400 mt-1">상세 분석 대기 중</p>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Pie Chart -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm lg:col-span-1">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                    <i data-lucide="pie-chart" class="w-4 h-4 text-slate-400"></i> 카테고리별 비중
                </h3>
                <div class="h-64 relative">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- Monthly Bar Chart -->
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm lg:col-span-2">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm">
                    <i data-lucide="bar-chart-3" class="w-4 h-4 text-slate-400"></i> 월별 지출 추이 (2025)
                </h3>
                <div class="h-64 relative">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-slate-800 text-sm flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4 text-slate-400"></i> 가맹점별 통합 지출 (Top 100)
                </h3>
                <span class="text-xs text-slate-500 bg-white px-2 py-1 rounded border">유사 상호명 자동 합산됨</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-100/50">
                        <tr>
                            <th class="px-6 py-3">가맹점명 (대표명칭)</th>
                            <th class="px-6 py-3 w-32">카테고리</th>
                            <th class="px-6 py-3 w-24 text-center">결제 건수</th>
                            <th class="px-6 py-3 w-40 text-right">총 금액</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100">
                        <!-- JS generated -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-lg shadow-xl transform translate-y-20 transition-all duration-300 opacity-0 flex items-center gap-3 z-50">
        <i data-lucide="check-circle" class="text-green-400"></i>
        <div>
            <p class="font-bold text-sm" id="toastTitle">준비 완료</p>
            <p class="text-xs text-slate-300" id="toastMsg">CSV 파일을 화면에 드래그하거나 업로드하세요.</p>
        </div>
    </div>

    <script>
        // --- 1. 초기 미리보기 데이터 ---
        const PREVIEW_DATA = [
            { date: "2025-01-29", store: "메리엔다", amount: 40800, rawDate: "01.29" },
            { date: "2025-01-28", store: "주식회사 카카오", amount: 13500, rawDate: "01.28" },
            { date: "2025-01-28", store: "파파야리프 코엑", amount: 87500, rawDate: "01.28" },
            { date: "2025-01-27", store: "SK에너지(주)", amount: 142000, rawDate: "01.27" },
            { date: "2025-01-27", store: "(주)신세계 하", amount: 15500, rawDate: "01.27" },
            { date: "2025-01-27", store: "주식회사 스타필", amount: 38000, rawDate: "01.27" },
            { date: "2025-12-31", store: "쿠팡", amount: 42600, rawDate: "12.31" },
            { date: "2025-12-31", store: "라체나", amount: 108200, rawDate: "12.31" },
            { date: "2025-12-31", store: "라체나", amount: 50000, rawDate: "12.31" }
        ];

        // --- 2. 카테고리 로직 ---
        const categories = {
            '식비/카페': ['식당', '요리', '키친', '카페', '커피', '푸드', '국밥', '면', '버거', '피자', '갈비', '육감만족', '라체나', '메리엔다', '파파야리프', '스타벅스', '투썸', '맥도날드', '롯데리아', '삼계탕', '한식'],
            '쇼핑/마트': ['쿠팡', '이마트', '신세계', '스타필드', '다이소', '편의점', '마트', '빅바이', '올리브영', '컬리', '네이버파이낸셜'],
            '교통/차량': ['주유', 'SK', 'GS칼텍스', '오일', '택시', '카카오', '주차', '하이패스', 'S-OIL', '에스케이', '교통'],
            '비즈니스': ['주식회사', '코엑', '시대에듀', '우체국', '세무', '법무', '토스페이먼츠', '이니시스', '나이스'],
            '문화/여가': ['CGV', '롯데시네마', '골프', '서점', '문고', '호텔', '리조트'],
        };

        function detectCategory(storeName) {
            if (!storeName) return '기타 운영비';
            const clean = storeName.replace(/\s/g, '');
            for (const [cat, keywords] of Object.entries(categories)) {
                if (keywords.some(k => storeName.includes(k) || clean.includes(k))) return cat;
            }
            return '기타 운영비';
        }

        // --- 3. 유사 가맹점 이름 정규화 함수 ---
        function normalizeStoreName(name) {
            if (!name) return "";
            let n = name.toString();
            // 1. 전각 문자 -> 반각 문자 변환 (ＳＫ -> SK 등)
            n = n.replace(/[\uFF01-\uFF5E]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
            n = n.replace(/\u3000/g, ' '); // 전각 스페이스

            // 2. 법인/사업자 형태 및 괄호 제거 (주식회사, 유한회사, (주), (유) 등)
            // (주), (유), (사) 등을 먼저 제거하고, 그 뒤 한글로 된 '주식회사' 등도 제거
            n = n.replace(/주식회사|유한회사|사단법인|\(주\)|\(유\)|\(사\)|（주）|（유）|\[주\]/g, '');

            // 3. 특수문자 및 공백 모두 제거 (순수 한글/영문/숫자만 남김)
            // 예: "SK에너지(주)" -> "SK에너지", "주식회사 카카오" -> "카카오"
            n = n.replace(/[^0-9a-zA-Z가-힣]/g, '');

            return n.toUpperCase();
        }

        // --- 4. 차트 및 데이터 처리 ---
        let categoryChart, monthlyChart;

        function initDashboard(data, isFullData = false) {
            const catSum = {};
            const monthSum = {};
            
            // 데이터 전처리 (카테고리 및 날짜)
            const enrichedData = data.map(d => {
                const cat = d.category || detectCategory(d.store);
                let dateKey = d.date;
                if (d.date.length < 8) dateKey = "2025-01-01"; 
                const monthKey = dateKey.substring(0, 7); 
                
                catSum[cat] = (catSum[cat] || 0) + d.amount;
                monthSum[monthKey] = (monthSum[monthKey] || 0) + d.amount;
                
                return { ...d, category: cat, month: monthKey };
            });

            // UI 업데이트 (풀 데이터일 경우에만 상단 요약 갱신)
            if (isFullData) {
                const total = enrichedData.reduce((acc, cur) => acc + cur.amount, 0);
                document.getElementById('totalAmount').innerText = total.toLocaleString(undefined, { maximumFractionDigits: 0 }) + '원';
                document.getElementById('totalCount').innerText = enrichedData.length.toLocaleString() + '건';
                document.getElementById('avgSpend').innerText = Math.round(total / enrichedData.length).toLocaleString() + '원';
                
                // 최다 지출처 계산 (정규화 적용)
                const storeSum = {};
                enrichedData.forEach(d => {
                    const normName = normalizeStoreName(d.store);
                    storeSum[normName] = (storeSum[normName] || 0) + d.amount;
                });
                
                // 최다 지출처 찾기 (정규화된 키를 다시 원래 이름으로 매핑하는 로직은 아래 renderTable에서 더 정교하게 처리됨)
                // 여기서는 단순히 가장 큰 금액의 키를 찾음
                // (약식 구현)
                const topNorm = Object.keys(storeSum).length > 0 ? Object.keys(storeSum).reduce((a, b) => storeSum[a] > storeSum[b] ? a : b) : "-";
                
                // 해당 정규화된 이름에 매칭되는 원본 이름 중 하나 찾기
                const topOriginal = enrichedData.find(d => normalizeStoreName(d.store) === topNorm)?.store || topNorm;
                
                // (주), 공백 제거된 깔끔한 이름으로 표시
                document.getElementById('topStore').innerText = topOriginal.replace(/주식회사|\(주\)/g, '').trim(); 
            }

            renderCharts(catSum, monthSum);
            renderTable(enrichedData); 
            
            if(isFullData) showToast("분석 완료", `${data.length}건의 데이터를 유사 가맹점끼리 통합했습니다.`);
        }

        function renderCharts(catSum, monthSum) {
            if (categoryChart) categoryChart.destroy();
            if (monthlyChart) monthlyChart.destroy();

            const sortedCats = Object.entries(catSum).sort((a,b) => b[1] - a[1]);
            categoryChart = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: {
                    labels: sortedCats.map(x => x[0]),
                    datasets: [{
                        data: sortedCats.map(x => x[1]),
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981', '#6366f1', '#8b5cf6', '#cbd5e1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } } }
            });

            const sortedMonths = Object.keys(monthSum).sort();
            monthlyChart = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '월별 지출액',
                        data: sortedMonths.map(m => monthSum[m]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2,4] } }, x: { grid: { display: false } } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            
            // 유사 가맹점 통합 로직 (Aggregation Logic)
            const storeMap = {};
            data.forEach(d => {
                const rawName = d.store;
                // 정규화된 이름을 키로 사용 (예: "SK에너지(주)" -> "SK에너지")
                const normalized = normalizeStoreName(rawName);
                
                if (!storeMap[normalized]) {
                    storeMap[normalized] = {
                        displayName: rawName, // 일단 첫 번째 이름을 대표 이름으로 설정
                        category: d.category,
                        count: 0,
                        totalAmount: 0
                    };
                } else {
                    // 더 짧은 이름이 있다면 대표 이름으로 교체 (예: "주식회사 카카오" 대신 "카카오" 선호)
                    if (rawName.length < storeMap[normalized].displayName.length) {
                        storeMap[normalized].displayName = rawName;
                    }
                }
                storeMap[normalized].count += 1;
                storeMap[normalized].totalAmount += d.amount;
            });

            // 배열로 변환 후 총 금액 내림차순 정렬
            const aggregatedData = Object.values(storeMap).sort((a, b) => b.totalAmount - a.totalAmount);
            const displayData = aggregatedData.slice(0, 100);
            
            tbody.innerHTML = displayData.map(d => `
                <tr class="hover:bg-slate-50 border-b border-slate-50 last:border-0">
                    <td class="px-6 py-3 font-bold text-slate-800 truncate max-w-[200px]">${d.displayName}</td>
                    <td class="px-6 py-3"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs whitespace-nowrap">${d.category}</span></td>
                    <td class="px-6 py-3 text-center text-slate-500">${d.count}건</td>
                    <td class="px-6 py-3 text-right font-bold text-blue-600">${d.totalAmount.toLocaleString()}원</td>
                </tr>
            `).join('');
        }

        function showToast(title, msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastTitle').innerText = title;
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 5000);
        }

        function showStatus(msg) {
            const el = document.getElementById('statusArea');
            document.getElementById('statusMsg').innerText = msg;
            el.classList.remove('hidden');
        }

        function handleDrop(e) {
            e.preventDefault();
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        }

        function handleFile(file, encoding = 'UTF-8') {
            if (!file) return;
            document.getElementById('statusArea').classList.add('hidden');

            Papa.parse(file, {
                header: false, 
                encoding: encoding,
                skipEmptyLines: 'greedy',
                complete: function(results) {
                    const success = processFullData(results.data);
                    
                    if (!success && encoding === 'UTF-8') {
                        showStatus("한글 깨짐이 감지되어 'EUC-KR' 인코딩으로 재시도합니다...");
                        setTimeout(() => handleFile(file, 'EUC-KR'), 500);
                    } else if (!success) {
                        alert("파일 형식을 인식할 수 없습니다.");
                    }
                },
                error: function(err) {
                    alert("파일 읽기 오류: " + err.message);
                }
            });
        }

        function processFullData(rows) {
            let headerIdx = -1;
            for(let i = 0; i < Math.min(rows.length, 50); i++) {
                const rowStr = rows[i].join('');
                if (rowStr.includes('이용일자') || rowStr.includes('승인일자') || rowStr.includes('거래일자')) {
                    headerIdx = i;
                    break;
                }
            }

            if (headerIdx === -1) return false; 

            const h = rows[headerIdx];
            const cleanHeader = h.map(c => c ? c.toString().replace(/\s/g,'').replace(/\n/g,'') : '');
            
            const iDate = cleanHeader.findIndex(c => c.includes('이용일자') || c.includes('승인일자'));
            const iStore = cleanHeader.findIndex(c => c.includes('이용가맹점') || c.includes('가맹점명'));
            const iAmt = cleanHeader.findIndex(c => c.includes('승인금액') || c.includes('이용금액') || c.includes('금액'));
            
            if (iDate === -1 || iAmt === -1) return false; 

            const newData = [];
            for(let i = headerIdx + 1; i < rows.length; i++) {
                const r = rows[i];
                if (!r[iDate] || !r[iAmt]) continue;

                const amtStr = r[iAmt].toString().replace(/,/g,'').replace(/"/g,'').trim();
                const amt = parseFloat(amtStr);
                if (isNaN(amt)) continue;

                const dateRaw = r[iDate].toString().trim();
                let fullDate = "";
                
                if (dateRaw.includes('.')) {
                    let [dPart] = dateRaw.split(' ');
                    let [m, d] = dPart.split('.').map(Number);
                    
                    let y = 2025; 
                    
                    fullDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                } else {
                    fullDate = dateRaw; 
                }

                newData.push({
                    date: fullDate,
                    store: r[iStore] || "미확인",
                    amount: amt,
                    category: detectCategory(r[iStore] || "")
                });
            }

            if (newData.length === 0) return false;

            initDashboard(newData, true);
            return true;
        }

        lucide.createIcons();
        window.onload = () => initDashboard(PREVIEW_DATA, false);
    </script>
</body>
</html>
